resources:
  - repo: self

variables:
  # Image tag
  tag: "$(Build.BuildId)"
  # Agent VM image name
  vmImageName: "ubuntu-latest"

stages:
  - stage: Build
    displayName: Building Container Image
    jobs:
      - job: Build
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              containerRegistry: "$(dockerRegistryServiceConnection)"
              repository: "$(imageRepository)"
              command: "buildAndPush"
              Dockerfile: "$(Build.SourcesDirectory)/docker/dockerfile"
              buildContext: "$(Build.SourcesDirectory)"
              tags: |
                $(tag)
                latest

  - stage: Deploy
    displayName: Deploy
    jobs:
      - deployment:
        displayName: Deploy Api
        pool: Azure Pipelines
        timeoutInMinutes: 5
        environment: "$(devopsEnvironment)"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - task: KubernetesManifest@1
                  inputs:
                    action: "patch"
                    kind: "Deployment"
                    name: "$(apiDeploymentName)"
                    namespace: "$(namespace)"
                    connectionType: "kubernetesServiceConnection"
                    kubernetesServiceConnection: "$(kubernetesServiceConnection)"
                    mergeStrategy: strategic
                    patch: '{"spec":{"template":{"spec":{"containers":[{"name":"$(apiDeploymentName)","image":"$(containerRegistry)/$(imageRepository):$(tag)"}]}}}}'
                - task: KubernetesManifest@1
                  inputs:
                    action: "patch"
                    kind: "Deployment"
                    name: "$(workerDeploymentName)"
                    namespace: "$(namespace)"
                    connectionType: "kubernetesServiceConnection"
                    kubernetesServiceConnection: "$(kubernetesServiceConnection)"
                    mergeStrategy: strategic
                    patch: '{"spec":{"template":{"spec":{"containers":[{"name":"$(workerDeploymentName)","image":"$(containerRegistry)/$(imageRepository):$(tag)"}]}}}}'
